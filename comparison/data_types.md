# Python vs Rust 数据类型深度对比

> 两种语言，两种哲学，两种内存世界

---

## 一、设计哲学：灵活 vs 安全

```
┌─────────────────────────────────────────────────────────────────────┐
│                         设计理念光谱                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  灵活/简单                                           安全/高效      │
│     ◀━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━▶         │
│                                                                     │
│     🐍 Python                                    🦀 Rust            │
│     "我们都是成年人"                              "编译器是你的朋友"  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

| 维度 | Python 🐍 | Rust 🦀 |
|------|-----------|---------|
| **核心理念** | 开发效率优先 | 运行效率+安全 |
| **类型系统** | 动态类型（运行时检查） | 静态类型（编译期检查） |
| **内存管理** | 垃圾回收（自动） | 所有权（零开销） |
| **错误处理** | 异常 | Result/Option |
| **座右铭** | "人生苦短，我用Python" | "无畏并发" |

---

## 二、变量的本质：标签 vs 盒子

这是理解两种语言最关键的区别！

### Python：变量是贴在对象上的**标签**

```
a = 42
b = a

     命名空间                         堆
┌──────────────┐              ┌─────────────────┐
│  "a" ────────┼──────┐       │   int 对象      │
├──────────────┤      │       │  ┌───────────┐  │
│  "b" ────────┼──────┴──────▶│  │ refcount=2│  │
└──────────────┘              │  │ type→int  │  │
   都是标签                    │  │ value=42  │  │
   指向同一对象                │  └───────────┘  │
                              └─────────────────┘
```

### Rust：变量是装数据的**盒子**

```
let a: i32 = 42;
let b = a;        // 值被复制！

        栈
┌─────────────────┐
│   a: │ 42 │     │  ← 值直接在这里
├──────┼────┼─────┤
│   b: │ 42 │     │  ← 独立的副本
└──────┴────┴─────┘
```

### 核心区别

```
Python 赋值 = 贴标签（共享）      Rust 赋值 = 复制/移动（独立）

    a ──┐                            ┌─────┐   ┌─────┐
         ├──▶ [对象]                 │  a  │   │  b  │
    b ──┘                            │ 42  │   │ 42  │
                                     └─────┘   └─────┘
  修改对象，a和b都变                   修改a，b不变
```

---

## 三、内存布局对比

### 3.1 整数

```
Python int (值 = 42)                    Rust i32 (值 = 42)
┌──────────────────────┐                ┌────┬────┬────┬────┐
│ 引用计数    (8 字节) │                │ 2A │ 00 │ 00 │ 00 │  仅 4 字节！
├──────────────────────┤                └────┴────┴────┴────┘
│ 类型指针    (8 字节) │                
├──────────────────────┤                开销对比：
│ 数字个数    (8 字节) │                ┌────────────────────┐
├──────────────────────┤                │ Python: 28+ 字节   │
│ digit[0]    (4 字节) │ = 42           │ Rust:   4 字节     │
└──────────────────────┘                │ 差距:   7倍+       │
总计: 28 字节（小整数）                  └────────────────────┘

Python 大整数 (值 = 2⁶⁰)                Rust: 没有内置大整数
┌──────────────────────┐                需要 i128 或外部库
│ 引用计数    (8 字节) │                
├──────────────────────┤                i128 最大: 2¹²⁷-1
│ 类型指针    (8 字节) │                超出需要 BigInt crate
├──────────────────────┤
│ 数字个数=3  (8 字节) │
├──────────────────────┤
│ digit[0..2] (12字节) │
└──────────────────────┘
总计: 36 字节，可无限扩展
```

**关键差异**：

| 特性 | Python | Rust |
|------|--------|------|
| 精度 | **无限** | 固定（i8~i128） |
| 溢出 | 自动扩展 | panic 或回绕 |
| 内存 | 28+ 字节 | 1~16 字节 |
| 分配 | 堆 | 栈 |

---

### 3.2 浮点数

```
两者内存布局相同（IEEE 754），但外壳不同：

Python float                           Rust f64
┌──────────────────────┐              ┌────────────────────────────────┐
│ 引用计数    (8 字节) │              │     IEEE 754 双精度            │
├──────────────────────┤              │         (8 字节)               │
│ 类型指针    (8 字节) │              └────────────────────────────────┘
├──────────────────────┤              
│ double 值   (8 字节) │ ◀── 相同 ──▶     直接就是值，无包装
└──────────────────────┘

总计: 24 字节                          总计: 8 字节
```

---

### 3.3 布尔值

```
Python bool                            Rust bool
┌──────────────────────┐              ┌────────┐
│ 引用计数    (8 字节) │              │ 0 或 1 │  仅 1 字节！
├──────────────────────┤              └────────┘
│ 类型指针    (8 字节) │              
├──────────────────────┤              Python bool 是 int 子类：
│ 数字个数    (8 字节) │              >>> True + True
├──────────────────────┤              2
│ digit[0]    (4 字节) │ 0或1         
└──────────────────────┘              Rust bool 独立，不能算术运算

总计: 28 字节                          总计: 1 字节
      比Rust大28倍！
```

---

### 3.4 字符串

```
Python str "hello"                     Rust String "hello"
┌──────────────────────┐              
│ 引用计数    (8 字节) │                  栈 (24B)              堆
├──────────────────────┤              ┌─────────────┐    ┌───────────┐
│ 类型指针    (8 字节) │              │ ptr ────────┼───▶│ h e l l o │
├──────────────────────┤              ├─────────────┤    └───────────┘
│ 长度        (8 字节) │ = 5          │ len: 5      │    
├──────────────────────┤              ├─────────────┤    
│ 哈希值      (8 字节) │              │ cap: 5+     │    
├──────────────────────┤              └─────────────┘
│ 编码标志    (若干)   │              
├──────────────────────┤              Rust &str "hello" (切片)
│ h e l l o \0         │              ┌─────────────┐
└──────────────────────┘              │ ptr ────────┼───▶ 数据
                                      ├─────────────┤
不可变，自适应编码                     │ len: 5      │
                                      └─────────────┘
                                      不可变，借用，仅 16 字节
```

**关键差异**：

| 特性 | Python str | Rust String | Rust &str |
|------|-----------|-------------|-----------|
| 可变 | ❌ | ✅ | ❌ |
| 所有权 | 有 | 有 | 借用 |
| 索引 | O(1)* | O(n) | O(n) |
| 编码 | 自适应 | UTF-8 | UTF-8 |

*Python 对纯 ASCII 是 O(1)

---

### 3.5 列表 vs Vec

```
Python list [1, 2, 3]                  Rust Vec<i32> vec![1, 2, 3]

对象头 + 指针数组                       栈 + 堆
┌──────────────────────┐              ┌─────────────┐    堆
│ 引用计数    (8 字节) │              │ ptr ────────┼──▶┌───┬───┬───┐
├──────────────────────┤              ├─────────────┤   │ 1 │ 2 │ 3 │
│ 类型指针    (8 字节) │              │ len: 3      │   └───┴───┴───┘
├──────────────────────┤              ├─────────────┤    直接存值！
│ 长度: 3     (8 字节) │              │ cap: 3+     │
├──────────────────────┤              └─────────────┘
│ 数组指针    (8 字节) │──┐           
├──────────────────────┤  │           
│ 容量        (8 字节) │  │           Rust 存值，Python 存指针：
└──────────────────────┘  │           
                          ▼           Python: [ptr, ptr, ptr] → [obj, obj, obj]
┌─────┬─────┬─────┐                   Rust:   [1, 2, 3] 直接连续存储
│ ptr │ ptr │ ptr │ 指针数组
└──┬──┴──┬──┴──┬──┘
   ▼     ▼     ▼
  int   int   int   每个元素是独立对象！
```

**内存效率对比**（存储 1000 个 int）：

```
Python: 56KB+ (对象头×1000 + 指针数组)
Rust:   4KB  (连续 1000 个 i32)
差距:   14倍
```

---

### 3.6 元组

```
Python tuple (1, 2, 3)                 Rust (i32, i32, i32)
┌──────────────────────┐              ┌─────┬─────┬─────┐
│ 引用计数    (8 字节) │              │  1  │  2  │  3  │
├──────────────────────┤              └─────┴─────┴─────┘
│ 类型指针    (8 字节) │               12 字节，栈上连续
├──────────────────────┤
│ 长度: 3     (8 字节) │              类型是结构的一部分：
├──────────────────────┤              (i32, i32, i32) ≠ (i32, i32)
│ ptr → int 1 (8字节)  │
├──────────────────────┤
│ ptr → int 2 (8字节)  │
├──────────────────────┤
│ ptr → int 3 (8字节)  │
└──────────────────────┘
 48 字节 + 3个int对象
```

---

### 3.7 字典 vs HashMap

```
两者都用哈希表，但存储方式不同：

Python dict {"a": 1}                   Rust HashMap<&str, i32>
┌─────────────────┐                   ┌─────────────────┐
│ 对象头 (24B)    │                   │ 控制信息        │
├─────────────────┤                   ├─────────────────┤
│ 哈希表指针      │──▶ 稀疏索引       │ 桶数组指针      │──▶ 键值对数组
├─────────────────┤                   ├─────────────────┤
│ 键值对数组指针  │──▶ 紧凑存储       │ 元素数量        │
├─────────────────┤    ↓              └─────────────────┘
│ 元素数量        │   [hash|key|val]       ↓
└─────────────────┘   [hash|key|val]  [hash|key|val|...]
                        ↓   ↓   ↓
键和值都是指针          键值都是PyObject*  键值直接内联存储
```

---

## 四、内存管理：GC vs 所有权

### Python：引用计数 + 垃圾回收

```
a = [1, 2, 3]     # refcount = 1
b = a             # refcount = 2
del a             # refcount = 1
del b             # refcount = 0 → 立即释放

循环引用问题：
┌───────────────┐
│ list A        │──────┐
│ refcount=1    │      │
└───────┬───────┘      │
        │              │
        ▼              │
┌───────────────┐      │
│ list B        │◀─────┘
│ refcount=1    │
└───────────────┘
  互相引用，计数永远≥1
  需要 GC 周期性扫描清理
```

### Rust：所有权系统

```
let s1 = String::from("hello");

     s1                    堆
┌──────────┐         ┌───────────┐
│ ptr ─────┼────────▶│ h e l l o │
│ len: 5   │         └───────────┘
│ cap: 5   │
└──────────┘
   s1 拥有数据

let s2 = s1;  // 所有权转移！

     s1                    堆
┌──────────┐         ┌───────────┐
│ 已失效   │    ╳    │ h e l l o │
└──────────┘         └─────┬─────┘
                           │
     s2                    │
┌──────────┐               │
│ ptr ─────┼───────────────┘
│ len: 5   │
│ cap: 5   │
└──────────┘
   s2 现在拥有数据
   s1 不能再使用！

} // s2 离开作用域，自动释放堆内存
```

### 借用：安全的共享

```rust
fn print_len(s: &String) {  // 借用，不获取所有权
    println!("{}", s.len());
}  // 借用结束，原数据不受影响

let s = String::from("hello");
print_len(&s);   // 借出
println!("{}", s);  // 还能用！
```

---

## 五、类型转换

### Python：鸭子类型，运行时检查

```python
x = 42
x = "hello"    # OK，变量可以绑定任何类型
x = [1, 2, 3]  # OK

# 隐式转换
1 + 1.5        # int 自动转 float → 2.5
"a" * 3        # → "aaa"

# 显式转换
int("42")      # → 42
str(42)        # → "42"
```

### Rust：严格类型，编译期检查

```rust
let x: i32 = 42;
// x = "hello";  // 编译错误！类型不匹配

// 无隐式转换
// let y: i64 = x;     // 错误！
let y: i64 = x as i64; // 必须显式转换

// let z = x + 1.5;    // 错误！类型不同
let z = x as f64 + 1.5; // OK
```

---

## 六、性能对比

```
任务：处理 100 万个整数求和

Python:
┌────────────────────────────────────────┐
│ 100万次：                              │
│   - 取指针 → 检查类型 → 取值 → 加法   │
│   - 创建新对象 → 更新引用计数         │
│ 约 50-100ms                            │
└────────────────────────────────────────┘

Rust:
┌────────────────────────────────────────┐
│ 100万次：                              │
│   - 直接整数加法（CPU 原生指令）      │
│   - 可 SIMD 向量化                     │
│ 约 0.5-1ms                             │
└────────────────────────────────────────┘

差距: 50-100 倍
```

---

## 七、选择指南

```
                    ┌─────────────────────┐
                    │    你的项目需要？    │
                    └──────────┬──────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         ▼                     ▼                     ▼
    快速开发？            极致性能？            系统编程？
         │                     │                     │
         ▼                     ▼                     ▼
    ┌─────────┐          ┌─────────┐          ┌─────────┐
    │ Python  │          │  Rust   │          │  Rust   │
    │ 🐍      │          │  🦀     │          │  🦀     │
    └─────────┘          └─────────┘          └─────────┘

具体场景：
┌─────────────────┬─────────────┬─────────────┐
│ 场景            │ 推荐        │ 原因        │
├─────────────────┼─────────────┼─────────────┤
│ 数据分析/AI     │ Python 🐍   │ 生态丰富    │
│ Web 后端        │ 都可以      │ 看团队      │
│ CLI 工具        │ Rust 🦀     │ 分发方便    │
│ 嵌入式/OS       │ Rust 🦀     │ 无运行时    │
│ 游戏引擎        │ Rust 🦀     │ 性能关键    │
│ 脚本/自动化     │ Python 🐍   │ 开发速度    │
│ WebAssembly     │ Rust 🦀     │ 编译支持    │
└─────────────────┴─────────────┴─────────────┘
```

---

## 八、快速对照表

| 概念 | Python 🐍 | Rust 🦀 | 内存差异 |
|------|-----------|---------|----------|
| 整数 | `int` | `i32`, `i64`... | 28B vs 4B |
| 浮点 | `float` | `f64` | 24B vs 8B |
| 布尔 | `bool` | `bool` | 28B vs 1B |
| 字符 | 无（单字符串） | `char` | - vs 4B |
| 字符串 | `str` | `String`/`&str` | 变长 |
| 列表 | `list` | `Vec<T>` | 指针 vs 值 |
| 元组 | `tuple` | `(T1, T2)` | 指针 vs 内联 |
| 字典 | `dict` | `HashMap` | 类似 |
| 集合 | `set` | `HashSet` | 类似 |
| 空值 | `None` | `Option::None` | - |
| 类型检查 | 运行时 | 编译期 | - |
| 内存管理 | GC | 所有权 | 运行时 vs 零开销 |

---

## 九、一句话总结

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  Python: "一切皆对象，灵活至上"                                  │
│          付出内存代价，换取开发效率                              │
│                                                                 │
│  Rust:   "零成本抽象，安全第一"                                  │
│          付出学习成本，换取运行效率                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 练习

完成 `python/01_data_types/exercises/` 和 `rust/01_data_types/exercises/` 对比练习。
