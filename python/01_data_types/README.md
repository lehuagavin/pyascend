# Python 数据类型深度解析

## 一、设计哲学

### 1.1 一切皆对象

```python
x = 42
print(type(x))        # <class 'int'>
print(x.bit_length()) # 6

def greet(): pass
print(type(greet))    # <class 'function'>
```

### 1.2 鸭子类型

> "如果它走起来像鸭子，叫起来像鸭子，那它就是鸭子。"

Python 不关心对象的具体类型，只关心对象是否具有所需的方法。

### 1.3 协议优于继承

通过实现特殊方法（如 `__len__`、`__getitem__`）让对象支持各种操作，而非强制继承。

---

## 二、数据模型核心

### 2.1 对象的三个属性

```python
x = [1, 2, 3]
print(id(x))    # 身份（内存地址）
print(type(x))  # 类型
print(x)        # 值
```

### 2.2 可变性

| 不可变 | 可变 |
|--------|------|
| int, float, bool, str, tuple, frozenset | list, dict, set |

```python
# 不可变：修改会创建新对象
a = 10
a = a + 1  # 新对象

# 可变：原地修改
lst = [1, 2, 3]
lst.append(4)  # 同一对象
```

### 2.3 核心协议

| 协议 | 特殊方法 | 用途 |
|------|----------|------|
| 序列 | `__len__`, `__getitem__` | len()、索引、迭代 |
| 映射 | `__getitem__`, `__setitem__` | 字典式访问 |
| 可迭代 | `__iter__` | for 循环 |
| 可调用 | `__call__` | 函数调用 |

---

## 三、基本类型

### 3.1 整数 int

- **无限精度**：没有大小限制
- **小整数缓存**：-5 到 256 被复用

```python
# 小整数缓存
a = 256
b = 256
print(a is b)  # True

c = 257
d = 257
print(c is d)  # False
```

**内存布局**（以 2⁶⁰ 为例，需要 3 个 30 位单元）：

```
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → int 类型
├──────────────────────┤
│ 数字个数    (8 字节) │ = 3
├──────────────────────┤
│ digit[0]    (4 字节) │ = 0        ┐
├──────────────────────┤            │
│ digit[1]    (4 字节) │ = 0        ├ 值 = d₀ + d₁×2³⁰ + d₂×2⁶⁰
├──────────────────────┤            │
│ digit[2]    (4 字节) │ = 1        ┘
└──────────────────────┘
总计: 36 字节
```

```python
import sys
print(sys.getsizeof(0))       # 28 字节（1个单元）
print(sys.getsizeof(2**30))   # 32 字节（2个单元）
print(sys.getsizeof(2**60))   # 36 字节（3个单元）
```

### 3.2 浮点数 float

- IEEE 754 双精度（64位），存在**精度问题**

```python
print(0.1 + 0.2)  # 0.30000000000000004
print(0.1 + 0.2 == 0.3)  # False

import math
print(math.isclose(0.1 + 0.2, 0.3))  # True
```

**内存布局**（固定 24 字节）：

```
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → float 类型
├──────────────────────┤
│ double 值   (8 字节) │ IEEE 754 双精度
└──────────────────────┘
总计: 24 字节

IEEE 754 双精度格式 (64 位):
┌───┬─────────────┬────────────────────────────────────────────────────┐
│ S │  Exponent   │                    Mantissa                        │
│1位│   11 位     │                     52 位                          │
└───┴─────────────┴────────────────────────────────────────────────────┘
  ↓       ↓                          ↓
符号   指数偏移                   有效数字（约15-17位十进制精度）
```

### 3.3 布尔值 bool

- `bool` 是 `int` 的子类（`True == 1`, `False == 0`）
- 假值：`None`, `0`, `0.0`, `''`, `[]`, `{}`, `set()`

**内存布局**（与小整数相同，28 字节，且 True/False 是单例）：

```
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → bool 类型
├──────────────────────┤
│ 数字个数    (8 字节) │ = 1
├──────────────────────┤
│ digit[0]    (4 字节) │ = 0 或 1
└──────────────────────┘
```

### 3.4 字符串 str

- **不可变**
- **字符串驻留**：字面量会被缓存

```python
a = "hello"
b = "hello"
print(a is b)  # True（驻留）

c = "".join(['h','e','l','l','o'])
print(a is c)  # False（动态创建）
print(a == c)  # True
```

**内存布局**（以 "hello" 为例）：

```
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → str 类型
├──────────────────────┤
│ 长度        (8 字节) │ = 5
├──────────────────────┤
│ 哈希值      (8 字节) │ 缓存的哈希值
├──────────────────────┤
│ 编码类型等  (若干)   │ 标志位
├──────────────────────┤
│ 'h' 'e' 'l' 'l' 'o'  │ 字符数据（Latin-1: 各1字节）
├──────────────────────┤
│ '\0'                 │ 终止符
└──────────────────────┘
```

**自适应编码**（根据最大字符选择）：

| 字符范围 | 编码 | 每字符字节数 | 示例 |
|----------|------|--------------|------|
| ASCII (0-127) | Latin-1 | 1 | "hello" |
| BMP (0-65535) | UCS-2 | 2 | "你好" |
| 全 Unicode | UCS-4 | 4 | "😀" |

---

## 四、容器类型

### 4.1 列表 list

动态数组，可变，有序。

```python
lst = [x**2 for x in range(5)]  # 列表推导式

# 时间复杂度
# 索引 O(1) | append O(1) | insert O(n) | in O(n)
```

**内存布局**（以 `[1, 2, 3]` 为例）：

```
列表对象（栈上）              堆上
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → list 类型
├──────────────────────┤
│ 当前长度    (8 字节) │ = 3
├──────────────────────┤      ┌─────────────────────────────┐
│ 数组指针    (8 字节) │ ───→ │ ptr0 │ ptr1 │ ptr2 │ 预留  │
├──────────────────────┤      └──┬──────┬──────┬────────────┘
│ 分配容量    (8 字节) │ = 4     ↓      ↓      ↓
└──────────────────────┘        int    int    int
                                 1      2      3
```

- 列表存储的是**指针**，不是对象本身
- 空间不足时按约 **1.125 倍**扩容
- 预留空间避免频繁重新分配

### 4.2 元组 tuple

不可变，可哈希（可作字典键）。

```python
# 解包
a, b = 1, 2
a, b = b, a  # 交换

first, *rest = [1, 2, 3, 4]  # first=1, rest=[2,3,4]
```

**内存布局**（以 `(1, 2, 3)` 为例）：

```
┌──────────────────────┐
│ 引用计数    (8 字节) │
├──────────────────────┤
│ 类型指针    (8 字节) │ → tuple 类型
├──────────────────────┤
│ 长度        (8 字节) │ = 3
├──────────────────────┤
│ item[0]     (8 字节) │ → int 1
├──────────────────────┤
│ item[1]     (8 字节) │ → int 2
├──────────────────────┤
│ item[2]     (8 字节) │ → int 3
└──────────────────────┘

对比列表：
- 元组: 数据直接内联，无需额外指针数组
- 列表: 需要额外的指针数组 + 预留空间
- 元组更省内存（约少 16 字节开销）
```

### 4.3 字典 dict

哈希表实现，键必须可哈希，Python 3.7+ 保持插入顺序。

```python
d = {x: x**2 for x in range(5)}  # 字典推导式

# 时间复杂度：查找/插入/删除 O(1)

# 常用变体
from collections import defaultdict, Counter
dd = defaultdict(list)
c = Counter('abracadabra')  # {'a':5, 'b':2, ...}
```

**内存布局**（以 `{"a": 1, "b": 2}` 为例）：

```
字典对象                     哈希表（稀疏）              键值对数组（紧凑）
┌─────────────────┐         ┌───┬───┬───┬───┐         ┌─────────────────┐
│ 引用计数        │         │ 1 │   │ 0 │   │ ...     │ hash │ key │ val│
├─────────────────┤         └─┬─┴───┴─┬─┴───┘         ├──────┼─────┼────┤
│ 类型指针        │           │       │               │ h(a) │ "a" │ 1  │ ← 索引 0
├─────────────────┤           │       └──────────────→│ h(b) │ "b" │ 2  │ ← 索引 1
│ 键值对数量 = 2  │           └─────────────────────→ └─────────────────┘
├─────────────────┤
│ 哈希表指针      │ ─→ 哈希表（存储索引）
├─────────────────┤
│ 键值对数组指针  │ ─→ 紧凑数组
└─────────────────┘

查找过程：
1. 计算 hash(key)
2. 在哈希表中找到索引
3. 用索引访问键值对数组
4. 冲突时探测下一个槽位
5. 负载因子超过 2/3 时扩容
```

### 4.4 集合 set

无序，不重复，元素必须可哈希。

```python
a = {1, 2, 3, 4}
b = {3, 4, 5, 6}

a | b  # 并集 {1,2,3,4,5,6}
a & b  # 交集 {3,4}
a - b  # 差集 {1,2}
a ^ b  # 对称差集 {1,2,5,6}
```

**内存布局**（以 `{1, 2, 3}` 为例）：

```
集合对象                        哈希表
┌──────────────────────┐       ┌─────────────────────────────┐
│ 引用计数    (8 字节) │       │ slot │ slot │ slot │ slot  │
├──────────────────────┤       ├──────┼──────┼──────┼───────┤
│ 类型指针    (8 字节) │       │empty │  1   │  2   │   3   │
├──────────────────────┤       │      │ hash │ hash │ hash  │
│ 元素数量    (8 字节) │ = 3   └──────┴──────┴──────┴───────┘
├──────────────────────┤
│ 哈希表指针  (8 字节) │ ─→ 哈希表
├──────────────────────┤
│ 哈希表大小  (8 字节) │
└──────────────────────┘

与字典的区别：
- 字典: 存储 (hash, key, value)
- 集合: 只存储 (hash, key)，无 value
```

---

## 五、重要概念

### 5.1 is vs ==

```python
a = [1, 2, 3]
b = [1, 2, 3]
c = a

a == b  # True（值相等）
a is b  # False（不同对象）
a is c  # True（同一对象）
```

### 5.2 浅拷贝 vs 深拷贝

```python
import copy

original = [[1, 2], [3, 4]]

shallow = copy.copy(original)      # 浅拷贝
shallow[0].append(99)
print(original)  # [[1, 2, 99], [3, 4]] 受影响

original = [[1, 2], [3, 4]]
deep = copy.deepcopy(original)     # 深拷贝
deep[0].append(99)
print(original)  # [[1, 2], [3, 4]] 不受影响
```

### 5.3 变量是标签

```python
a = [1, 2, 3]
b = a        # b 和 a 指向同一个列表
b.append(4)
print(a)     # [1, 2, 3, 4]
```

---

## 六、底层原理

### 6.1 对象的内存结构

每个 Python 对象都包含：

```
+------------------+
| 引用计数 (8字节)  |  <- 记录有多少变量引用此对象
+------------------+
| 类型指针 (8字节)  |  <- 指向类型对象（如 int、list）
+------------------+
| 对象数据...       |  <- 实际存储的数据
+------------------+
```

```python
import sys
sys.getsizeof(1)        # 28 字节
sys.getsizeof([])       # 56 字节
sys.getsizeof({})       # 64 字节
```

### 6.2 引用计数

Python 通过引用计数管理内存：

```python
import sys

a = [1, 2, 3]
print(sys.getrefcount(a))  # 2（a + 函数参数）

b = a                      # 引用 +1
print(sys.getrefcount(a))  # 3

del b                      # 引用 -1
print(sys.getrefcount(a))  # 2
```

- 引用计数 = 0 时，对象被立即回收
- 循环引用由垃圾回收器（GC）处理

### 6.3 哈希与可哈希

```python
# 可哈希：不可变类型
hash(42)           # 42
hash("hello")      # -872773...
hash((1, 2, 3))    # 529344...

# 不可哈希：可变类型
hash([1, 2, 3])    # TypeError!
hash({1: 2})       # TypeError!
```

**规则**：可哈希对象在生命周期内哈希值不变，才能作为字典键或集合元素。

---

## 附录：快速参考

### 类型转换

```python
int('42')       # 42
float('3.14')   # 3.14
str(42)         # '42'
list((1,2,3))   # [1, 2, 3]
set([1,1,2,2])  # {1, 2}
```

### 推导式

```python
[x**2 for x in range(5) if x % 2 == 0]  # 列表
{x: x**2 for x in range(5)}              # 字典
{x for x in range(5)}                    # 集合
(x**2 for x in range(5))                 # 生成器
```

### 时间复杂度速查

| 操作 | list | dict | set |
|------|------|------|-----|
| 索引/查找 | O(1) | O(1) | O(1) |
| 插入 | O(n) | O(1) | O(1) |
| 追加 | O(1) | - | O(1) |
| 删除 | O(n) | O(1) | O(1) |
| 成员测试 in | O(n) | O(1) | O(1) |

---

## 练习

完成 `exercises/01_data_types/` 目录下的习题，答案在 `solutions/01_data_types/`。
